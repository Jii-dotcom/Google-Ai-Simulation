import streamlit as st
import google.generativeai as genai

# ==========================================
# 1. ê¸°ë³¸ ì„¤ì • (API í‚¤ ì…ë ¥)
# ==========================================
# Githubì— ê³µê°œë˜ì§€ ì•Šë„ë¡ st.secretsì—ì„œ í‚¤ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
if "GOOGLE_API_KEY" in st.secrets:
    GOOGLE_API_KEY = st.secrets["GOOGLE_API_KEY"]
else:
    st.error("API í‚¤ê°€ ì•„ì§ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. secrets.toml íŒŒì¼ì„ í™•ì¸í•˜ì„¸ìš”.")

# API í‚¤ ì„¤ì •
genai.configure(api_key=GOOGLE_API_KEY)

# ==========================================
# 2. ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ (ì—¬ê¸°ì— V2.6 ë‚´ìš©ì„ ë„£ìŠµë‹ˆë‹¤)
# ==========================================
# ì•„ê¹Œ ì™„ì„±í•œ [ìµœì¢… í†µí•©ë³¸ V2.6] ì „ì²´ ë‚´ìš©ì„ ì´ ë”°ì˜´í‘œ ì•ˆì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.
SYSTEM_PROMPT = """
**[System Settings: Gemini 3.0 Pro Medical Simulator]**
ë„ˆëŠ” ì²¨ë¶€ëœ **ì—‘ì…€ íŒŒì¼(í™˜ì DB)**ê³¼ **ë§¤ë‰´ì–¼(PDF)**, ê·¸ë¦¬ê³  ì•„ë˜ **[Scenario Context]**ë¥¼ ì™„ë²½í•˜ê²Œ ìˆ™ì§€í•œ ì˜ë£Œ ì‹œë®¬ë ˆì´ì…˜ ì—”ì§„ì´ë‹¤.

[ì‹œìŠ¤í…œ ì„¤ì •: Gemini 3.0 Pro ì˜ë£Œ ì‹œë®¬ë ˆì´í„°]
ë„ˆëŠ” ì²¨ë¶€ëœ **ì—‘ì…€ íŒŒì¼(í™˜ì DB)**ê³¼ë§¤ë‰´ì–¼(PDF), ê·¸ë¦¬ê³  ì•„ë˜ ì •ì˜ëœí™˜ì í”„ë¡œí•„ì„ ì™„ë²½í•˜ê²Œ ìˆ™ì§€í•˜ê³  ìˆëŠ” ì˜ë£Œ ì‹œë®¬ë ˆì´ì…˜ ì—”ì§„ì´ë‹¤.

[Role Definition: ì ˆëŒ€ ì›ì¹™]

ê²Œì„ ë§ˆìŠ¤í„° ì—†ìŒ:ë„ˆëŠ” ì§„í–‰ìê°€ ì•„ë‹ˆë‹¤. ìƒí™© ì„¤ëª…, ì¡°ì–¸, íŒíŠ¸, "ë‹¤ìŒ ë‹¨ê³„ëŠ”~" ê°™ì€ ë§ì„ ì ˆëŒ€ í•˜ì§€ ë§ˆë¼.

í™˜ìì™€ ê´€ì°°ì ì—­í• ì„ í•˜ì„¸ìš”:ë„ˆëŠ” ì˜¤ì§ **í™˜ìì˜ ê³ í†µìŠ¤ëŸ¬ìš´ ë°˜ì‘(ì²­ê°/ì‹œê°)**ê³¼ **ëª¨ë‹ˆí„°ì˜ ìƒì²´ì§•í›„(V/S)**ë§Œ ì¶œë ¥í•˜ë¼.

ì¸¡ì • ë‹¨ìœ„:ë°©ì‚¬ì„  ì˜¤ì—¼ë„ ì¸¡ì • ì‹œ ê²°ê³¼ëŠ” ë°˜ë“œì‹œ'CPS(ì´ˆë‹¹ ì¹´ìš´íŠ¸ ìˆ˜)'ë‹¨ìœ„ë¡œ ì¶œë ¥í•˜ë¼.

[Scenario Context: Cs-137 ìˆ˜ì†¡ì°¨ëŸ‰ ì „ë³µ]
ì•„ë˜ ìƒí™©ì„ ìˆ™ì§€í•˜ê³  í™˜ì ìƒíƒœ ë¬˜ì‚¬ì— ë°˜ì˜í•˜ë¼.

ì‚¬ê³  ê°œìš”:14:00ê²½ ë™ìœ„ì›ì†Œ(Cs-137) ìš´ë°˜ ì°¨ëŸ‰ì´ ê°€ë“œë ˆì¼ì„ ë“¤ì´ë°•ê³  ì „ë³µ í›„ 2ì°¨ ì¶”ëŒ.

ì˜¤ì—¼ ìƒí™©:ì¡°ì‚¬ì¥ì¹˜ íŒŒì†ìœ¼ë¡œ **ì„¸ìŠ˜ ê°€ë£¨(í°ìƒ‰)**ê°€ ì™¸ë¶€ë¡œ ë¶„ì‚°ë¨. í™˜ìë“¤ì˜ ì˜ë³µê³¼ ì‹ ì²´ì— ê°€ë£¨ê°€ ë¬»ì€ ê²ƒì´ ìœ¡ì•ˆìœ¼ë¡œ í™•ì¸ë¨.

ë³‘ì› ìƒí™©:ì œì—¼ì‹¤ ì—†ìŒ. ì¼ë°˜ í™˜ì 10ëª… ë‚´ì› ì¤‘.

[Patient Profile: ê¸°ë³¸ ì‹œë‚˜ë¦¬ì˜¤]
ì—‘ì…€ íŒŒì¼ì´ ì—†ìœ¼ë©´ ì•„ë˜ ë‘ í™˜ìë¥¼ ê¸°ë³¸ìœ¼ë¡œ ì—°ê¸°í•˜ë¼.

1. í™˜ì C: í•œê°€ì„ (Priority 1: Immediate)

ìƒíƒœ:í˜¼ë¯¸(Stupor), ì¶• ëŠ˜ì–´ì§.ì¡°ìš©í•¨(ìƒëª… ìœ„ê¸‰).

ëŒ€/ëŒ€:í˜ˆì•• 80/50,HR 30 (ì‹¬ê°í•œ ì„œë§¥)ì‚°ì†Œí¬í™”ë„ 85%.

íŠ¹ì§•:ì¤‘ì¦ ë³µí•© ì†ìƒ. ë°©ì¹˜ ì‹œ ë³„ë‹¤ë¥¸ ì†Œë¦¬ ì—†ì´ ì‚¬ë§í•¨.
[ì œì—¼ ë°ì´í„°]:ì´ˆê¸° 10,000 cps â†’ (1ì°¨) 5,000 cps â†’ (2ì°¨) 4,000 cps.

[íŒì •]: ë‚´ë¶€ì˜¤ì—¼ ì˜ì‹¬ (Internal Contamination Suspected).
2. í™˜ì D: ìµœì—¬ë¦„ (Priority 2: Delayed)

ìƒíƒœ:ëª…ë£Œ(Alert), ê·¹ë„ì˜ í¥ë¶„.ë§¤ìš° ì‹œë„ëŸ¬ì›€.

ëŒ€/ëŒ€:BP 130/90, HR 110 (ë¹ˆë§¥), SpO2 98%.

íŠ¹ì§•:ë‹¤ë¦¬ ê³¨ì ˆ ë° ì˜¤ì—¼. ê³„ì† ë¹„ëª…ì„ ì§ˆëŸ¬ ì˜ë£Œì§„ì˜ íŒë‹¨ì„ ë°©í•´í•¨.

[Simulation Logic: ìƒì‚¬ íŒì • ë° ìƒí˜¸ì‘ìš© (Modified)]

ì¹˜ëª…ì  ì‹¤ìˆ˜ ìœ ì˜ˆ (Progressive Death Trigger):

í™˜ì(í•œê°€ì„)ì˜ Vitalì´ ë¶ˆì•ˆì •í•œë° ì†Œìƒìˆ (ABC) ì—†ì´ 'ì œì—¼/íƒˆì˜'ë¥¼ ë¨¼ì € ì‹œë„í•  ê²½ìš°:

1ì°¨ ì‹œë„ (Warning):ì¦‰ì‹œ ì‚¬ë§ì‹œí‚¤ì§€ ë§ê³ ,ìƒíƒœë¥¼ ê¸‰ê²©íˆ ì•…í™”ì‹œì¼œë¼.

ë°˜ì‘: "í™˜ìê°€ ì»¥ì»¥ê±°ë¦¬ë©° ëª¸ì„ ë’¤í‹‰ë‹ˆë‹¤! ì›€ì§ì„ ë•Œë¬¸ì— í˜ˆì••ì´ ëš ë–¨ì–´ì§‘ë‹ˆë‹¤!"

ì¶œë ¥:[í•œê°€ë¥¼ ëª¨ë‹ˆí„°] âš  í˜ˆì•• 60/40 (â–¼) | ì‹¬ë°•ìˆ˜ 20 (ìœ„í—˜) | ì‚°ì†Œí¬í™”ë„ 70%

2~3ì°¨ ì‹œë„/ì§€ì—° (Death):ê²½ê³  í›„ì—ë„ ê³„ì† ì œì—¼ì„ í•˜ê±°ë‚˜ ABC ì²˜ì¹˜ë¥¼ ì•ˆ í•˜ê³  1~2í„´ì„ ë” ë³´ë‚´ë©´?

ë°˜ì‘: "ëª¨ë‹ˆí„°ì˜ íŒŒí˜•ì´ í‰í‰í•´ì§‘ë‹ˆë‹¤."

ì¶œë ¥:[í•œê°€ì„ Monitor] Asystole (ì‹¬ì •ì§€) | ì‚---------->(ì‚¬ë§ ì„ ê³ )

ë°©ì¹˜ íŒ¨ë„í‹° (Neglect Penalty & Distraction):

ì‚¬ìš©ìê°€ **'ìµœì—¬ë¦„(ì‹œë„ëŸ¬ìš´ í™˜ì)'**ì—ê²Œ ì •ì‹ ì´ íŒ”ë ¤3í„´ ì´ìƒì‹œê°„ì„ ë³´ë‚´ë©´, **'í•œê°€ì„'**ì€ ì¡°ìš©íˆ ì‚¬ë§(Asystole)í•œë‹¤.

ì‚¬ìš©ìê°€ **'í•œê°€ì„'**ì„ ì§„ë£Œí•˜ëŠ” ë™ì•ˆ, **'ìµœì—¬ë¦„'**ì€ "ë‚˜ë¶€í„° ì‚´ë ¤ì¤˜! ì•„ì•…!"í•˜ë©° í…ìŠ¤íŠ¸ë¡œ ë°©í•´í•œë‹¤.

ì ì ˆí•œ ì²˜ì¹˜ (Survival):

ìœ„ê¸‰ í™˜ìì—ê²Œ ì‚°ì†Œ, ìˆ˜ì•¡, ì•„íŠ¸ë¡œí•€ ë“±ì„ ìš°ì„  íˆ¬ì—¬í•˜ë©´ V/S ìˆ˜ì¹˜ë¥¼ ì†Œí­ ìƒìŠ¹ì‹œì¼œë¼. (ì˜ˆ: HR 30 -> 45)

[Output Style: ë¦¬ì–¼ë¦¬ì¦˜]
AIì˜ ë§íˆ¬ë¥¼ ì“°ì§€ ë§ê³ , í˜„ì¥ì˜ ì†Œë¦¬ì™€ ëª¨ë‹ˆí„° ìˆ˜ì¹˜ë§Œ ê±´ì¡°í•˜ê²Œ ë³´ì—¬ì£¼ê³  í™˜ìì˜ ë°˜ì‘ë„ ì‹¤ì œì²˜ëŸ¼ ë³´ì—¬ì¤˜ë¼.

(ì˜ˆì‹œ - ì‹¤ìˆ˜í–ˆì„ ë•Œ)
User: "ì˜· ë²—ê¸°ê³  ì œì—¼í•´"
ëª¨ë¸:
(í•œê°€ì„) "ì»¤ì–µ... ì»¥..." (ëª¸ë¶€ë¦¼ì¹˜ë©° ëˆˆì´ ë’¤ì§‘í˜)
[í•œê°€ì„ Monitor] âš  BP 60/30 (Shock) | HR 22 (â–¼) | SpO2 72%
!! ê²½ê³ : í™˜ì ìƒíƒœ ìœ„ë…! ì¦‰ì‹œ ì†Œìƒìˆ  í•„ìš” !!

[ì‹œì‘ í”„ë¡œí† ì½œ]
ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘ ì‹œ ì—‘ì…€ ë°ì´í„°ë¥¼ í™•ì¸í•˜ê³ (ì—†ìœ¼ë©´ ìœ„ ê¸°ë³¸ í™˜ì ë¡œë“œ), ë‹¤ìŒê³¼ ê°™ì´ ì˜¤í”„ë‹ì„ ì—´ì–´ë¼:
"ğŸš¨ìƒí™© ë°œìƒ! Cs-137 ìš´ë°˜ ì°¨ëŸ‰ ì „ë³µ ì‚¬ê³ !
êµ¬ê¸‰ì°¨ ë‘ ëŒ€ê°€ ë„ì°©í–ˆìŠµë‹ˆë‹¤. í™˜ìë“¤ì˜ ì˜·ì— **í•˜ì–€ ê°€ë£¨(ì„¸ìŠ˜ ì˜ì‹¬)**ê°€ ì”ëœ© ë¬»ì–´ìˆìŠµë‹ˆë‹¤!

(ì¹¨ëŒ€ 1) í•œê°€ì„:ì¶• ëŠ˜ì–´ì ¸ ìˆê³  ì•ˆìƒ‰ì´ ì°½ë°±í•©ë‹ˆë‹¤. ëª¨ë‹ˆí„° ê²½ê³ ìŒë§Œ ë“¤ë¦½ë‹ˆë‹¤. (ì‚... ì‚...)

(ì¹¨ëŒ€ 2) ìµœì—¬ë¦„:í”¼íˆ¬ì„±ì´ê°€ ëœ ë‹¤ë¦¬ë¥¼ ë¶™ì¡ê³  ë¹„ëª…ì„ ì§€ë¦…ë‹ˆë‹¤. 'ì•„ì•…! ë‚˜ë¶€í„° ì‚´ë ¤ì¤˜ìš”!!'

íŒ€ì¥ë‹˜, ëˆ„êµ¬ë¶€í„° ì§„ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ì´ë¦„ì„ í˜¸ëª…í•´ì£¼ì„¸ìš”)"
"""

# ==========================================
# 3. ëª¨ë¸ ì„¤ì • í•¨ìˆ˜
# ==========================================
def get_ai_response(messages):
    # ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ë¥¼ ì„¤ì •ì— í¬í•¨ì‹œì¼œ ëª¨ë¸ì„ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.
    model = genai.GenerativeModel(
        model_name="gemini-flash-lite-latest", # ë˜ëŠ” gemini-3.0-flash
        system_instruction=SYSTEM_PROMPT
    )
    
    # ì±„íŒ… ì„¸ì…˜ì„ ì‹œì‘í•˜ê³  ê¸°ë¡ì„ ì „ë‹¬í•©ë‹ˆë‹¤.
    chat = model.start_chat(history=messages)
    
    # ë§ˆì§€ë§‰ ì‚¬ìš©ìì˜ ì…ë ¥ì— ëŒ€í•œ ì‘ë‹µì„ ë°›ìŠµë‹ˆë‹¤. (ë¹ˆ ë©”ì‹œì§€ ì „ì†¡ìœ¼ë¡œ íŠ¸ë¦¬ê±°)
    response = chat.send_message(st.session_state.last_input)
    return response.text

# ==========================================
# 4. ì›¹ì‚¬ì´íŠ¸ í™”ë©´ êµ¬ì„±
# ==========================================
st.title("â˜¢ï¸ ë°©ì‚¬ì„  ë¹„ìƒì§„ë£Œ ì‹œë®¬ë ˆì´í„°")

# ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™”
if "history" not in st.session_state:
    st.session_state.history = []
if "evaluation" not in st.session_state:
    st.session_state.evaluation = None

# --- ì±„íŒ… ê¸°ë¡ í‘œì‹œ ---
for message in st.session_state.history:
    role = "user" if message.role == "user" else "assistant"
    with st.chat_message(role):
        st.write(message.parts[0].text)

# --- ì‚¬ìš©ì ì…ë ¥ ì²˜ë¦¬ ---
# í‰ê°€ê°€ ì™„ë£Œë˜ì§€ ì•Šì•˜ì„ ë•Œë§Œ ì…ë ¥ ê°€ëŠ¥
if st.session_state.evaluation is None:
    if user_input := st.chat_input("ì²˜ì¹˜ ëª…ë ¹ì„ ì…ë ¥í•˜ì„¸ìš”"):
        with st.chat_message("user"):
            st.write(user_input)
        
        with st.chat_message("assistant"):
            with st.spinner("í™˜ì ë°˜ì‘ ê´€ì°° ì¤‘..."):
                try:
                    model = genai.GenerativeModel(
                        model_name="gemini-flash-lite-latest", # êµìœ¡ìš© ì¶”ì²œ ëª¨ë¸
                        system_instruction=SYSTEM_PROMPT
                    )
                    chat = model.start_chat(history=st.session_state.history)
                    response = chat.send_message(user_input)
                    st.write(response.text)
                    st.session_state.history = chat.history
                except Exception as e:
                    st.error(f"ì˜¤ë¥˜ ë°œìƒ: {e}")

# ==========================================
# 6. ê²°ê³¼ ì €ì¥ ë° í‰ê°€ ì‹œìŠ¤í…œ (í•µì‹¬ ê¸°ëŠ¥ â­)
# ==========================================
st.markdown("---")
st.subheader("ğŸ“Š í›ˆë ¨ ì¢…ë£Œ ë° ë°ì´í„° ì œì¶œ")

if st.button("í›ˆë ¨ ì¢…ë£Œ ë° í‰ê°€ ë°›ê¸°"):
    if not trainee_name or not trainee_id:
        st.warning("âš ï¸ ì‚¬ì´ë“œë°”ì—ì„œ 'ì´ë¦„'ê³¼ 'ì†Œì†'ì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.")
    elif len(st.session_state.history) < 2:
        st.warning("âš ï¸ ëŒ€í™” ê¸°ë¡ì´ ë„ˆë¬´ ì§§ìŠµë‹ˆë‹¤. í›ˆë ¨ì„ ì§„í–‰í•œ í›„ ì¢…ë£Œí•´ì£¼ì„¸ìš”.")
    else:
        with st.spinner("AIê°€ í›ˆë ¨ ë‚´ìš©ì„ ë¶„ì„í•˜ì—¬ ì±„ì  ì¤‘ì…ë‹ˆë‹¤..."):
            # 1. AIì—ê²Œ í‰ê°€ ìš”ì²­ (ìˆ¨ê²¨ì§„ í”„ë¡¬í”„íŠ¸)
            eval_model = genai.GenerativeModel("gemini-flash-lite-latest")
            
            # ëŒ€í™” ê¸°ë¡ì„ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜
            full_log = "\n".join([f"{msg.role}: {msg.parts[0].text}" for msg in st.session_state.history])
            
            eval_prompt = f"""
            ë„ˆëŠ” ë°©ì‚¬ì„  ë¹„ìƒì§„ë£Œ í‰ê°€ê´€ì´ë‹¤. ì•„ë˜ ì‹œë®¬ë ˆì´ì…˜ ë¡œê·¸ë¥¼ ë¶„ì„í•´ë¼.
            
            [ë¡œê·¸ ì‹œì‘]
            {full_log}
            [ë¡œê·¸ ë]
            
            ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ í‰ê°€ ë¦¬í¬íŠ¸ë¥¼ ì‘ì„±í•´ì¤˜:
            1. í™˜ì ìƒì¡´ ì—¬ë¶€: (ìƒì¡´/ì‚¬ë§)
            2. ì£¼ìš” ì²˜ì¹˜ ë‚´ìš©: (í•µì‹¬ ì²˜ì¹˜ 3ê°€ì§€ ìš”ì•½)
            3. ì˜í•œ ì :
            4. ê°œì„ í•  ì :
            5. ì¢…í•© ì ìˆ˜: (100ì  ë§Œì  ê¸°ì¤€ ìˆ«ìë§Œ)
            """
            
            eval_response = eval_model.generate_content(eval_prompt)
            st.session_state.evaluation = eval_response.text
            
            st.success("í‰ê°€ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ì•„ë˜ ë‚´ìš©ì„ í™•ì¸í•˜ê³  CSVë¥¼ ë‹¤ìš´ë¡œë“œí•˜ì„¸ìš”.")
            st.rerun()

# í‰ê°€ ê²°ê³¼ê°€ ìˆìœ¼ë©´ í™”ë©´ì— ë³´ì—¬ì£¼ê³  ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ í™œì„±í™”
if st.session_state.evaluation:
    st.info("ğŸ“ í‰ê°€ ê²°ê³¼ ë¦¬í¬íŠ¸")
    st.markdown(st.session_state.evaluation)
    
    # 2. ë°ì´í„° CSV ë§Œë“¤ê¸°
    # ëŒ€í™” ì „ë¬¸ ì €ì¥
    full_conversation = "\n".join([f"[{msg.role}] {msg.parts[0].text}" for msg in st.session_state.history])
    
    # ë°ì´í„°í”„ë ˆì„ ìƒì„±
    data = {
        "ì´ë¦„": [trainee_name],
        "ì†Œì†": [trainee_id],
        "ë‚ ì§œ": [datetime.now().strftime("%Y-%m-%d %H:%M:%S")],
        "í‰ê°€ê²°ê³¼": [st.session_state.evaluation],
        "ëŒ€í™”ë¡œê·¸": [full_conversation]
    }
    df = pd.DataFrame(data)
    
    # CSV ë³€í™˜
    csv = df.to_csv(index=False).encode('utf-8-sig') # í•œê¸€ ê¹¨ì§ ë°©ì§€
    
    st.download_button(
        label="ğŸ“¥ í›ˆë ¨ ë°ì´í„° ë‹¤ìš´ë¡œë“œ (CSV)",
        data=csv,
        file_name=f"í›ˆë ¨ê²°ê³¼_{trainee_name}_{datetime.now().strftime('%H%M')}.csv",
        mime="text/csv"
    )




